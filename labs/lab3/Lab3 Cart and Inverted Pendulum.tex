
\makeatletter
\def\input@path{{../styles/}{../../styles/}{../../../styles/}{../}{../../}{../../../}}
\makeatother
\documentclass{ee122_labs}
\input{macros.tex}
\input{preamble.tex}

\begin{document}

\begin{center}
\Large{
\textbf{School of Engineering} \\
\textbf{University of California, Merced} \\
\noindent\rule{6.5in}{1.5pt} \\
\textbf{ME 141 - Control Engineering} \\
\textbf{ } \\
 \vspace{150mm}
\textbf{\large{Experiment No. Three}} \\
\textbf{ } \\
\textbf{Balance Control of an Inverted Pendulum}
}
\end{center}

\pagebreak

% If you wish to include an abstract, uncomment the lines below
% \begin{abstract}
% Abstract text
% \end{abstract}

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------

\section*{Objectives}

\begin{itemize}
    \item[1.] Obtain a linear state-space representation of an open-loop system.
    \item[2.] Design a state-feedback controller using LQR.
\end{itemize} 
 
%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section*{Background}

\subsection*{(a) Linear State-Space Model}

The linear Single Inverted Pendulum (SIP) model is shown below: \\

\begin{figure}[H]
    \centering
    \includegraphics{lab3/IMG_LinearInvertedPendulumSchematic.jpg}
    \caption{Linear Inverted Pendulum Schematic}
    \label{fig:my_label}
\end{figure}

The pendulum pivot is on the IP02 cart, and is measured using the $Pendulum$ encoder. The center of mass of the pendulum is at length, $l_p$, and the moment of inertia about the center of mass is $J_p$. The pendulum angle, $\alpha$, is zero when it is perfectly balanced in an inverted position and increases positively when rotated counter-clockwise (CCW). The posistive direction of linear displacement of the cart, $x_c$, is to the right when facing the cart. The position of the pendulum center of gravity is denoted as the $(x_p,y_p)$ coordinate. The equations of motion (EOM) of the pendulum gantry to account for the orientation of the inverted pendulum yield the following equations for the acceleration of the cart and pendulum:

\begin{center}
    \begin{equation}
        \ddot{x_c} = \frac{1}{J_T}(-(J_p+M_pl_p^2)B_{eq}\dot{x_c}-M_pl_pB_p\dot{\alpha}+M_p^2l_p^2g\alpha+(J_p+M_pl_p^2)F_c)
        \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
        \ddot{\alpha} = \frac{1}{J_T}(-(M_pl_pB_{eq})\dot{x_c}-(J{eq}+M_p)B_p\dot{\alpha}+(J_{eq}+M_p)M_pl_pg\alpha+M_pl_pF_c)
    \end{equation}
\end{center}

where $J_T = J_{eq}J_p+M_pJ_p+J_{eq}M_pl_p^2$ and $J_{eq}=M_c+\frac{\nu_gK_g^2J_m}{r_{mp}^2}$. For the linear inverted pendulum system, the state is defined as:

\begin{center}
    \begin{equation}
        x^T = [x_c \quad \alpha \quad \dot{x}_c \quad \dot{\alpha}]
    \end{equation}
\end{center}

Where we can define $\dot{x}_1=x_3$ and $\dot{x}_2=x_4$. Substituting state $x$ into the equations of motion where $x_c=x_1$, $\alpha=x_2$, $\dot{x}_c=x_3$, $\dot{\alpha}=x_4$ gives

\begin{center}
    \begin{equation}
        \dot{x_3} = \frac{1}{J_T}(-(J_p+M_pl_p^2)B_{eq}x_3-M_pl_pB_px_4+M_p^2l_p^2gx_2+(J_p+M_pl_p^2)u)
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
        \ddot{x_4} = \frac{1}{J_T}(-(M_pl_pB_{eq})x_3-(J_{eq}+M_p)B_px_4+(J_{eq}+M_p)M_pl_pgx_2+M_pl_pu)
    \end{equation}
\end{center}

The $A$ and $B$ matrices in the $\dot{x_c} = Ax+Bu$ equation are therefore:

\begin{center}
    \begin{equation}
    A=\frac{1}{J_T}
    \left[
        \begin{tabular}{ c c c c }
            0 & 0 & 1 & 0 \\ 
            0 & 0 & 0 & 1 \\  
            0 & $M_p^2l_p^2g$ & $-(J_p+M_pl_p^2)B_{eq}$ & $-M_p l_p B_p$ \\
            0 & $(J_{eq}+M_p)M_pl_pg$ & $-M_pl_pB_{eq}$ & $-(J_{eq}+M_p)B_p$
        \end{tabular}
    \right]
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
    B=\frac{1}{J_T}
    \left[
        \begin{tabular}{ c }
            0 \\ 
            0 \\  
            $J_p+M_pl_p^2$ \\
            $M_pl_p$
        \end{tabular}
    \right]
    \end{equation}
\end{center}

In the output equation, only the position of the cart and pendulum angle is being measured. Based on this, the $C$ and $D$ matrices in the output equation are

\begin{center}
    \begin{equation}
    C=
    \left[
        \begin{tabular}{ c c c c }
            1 & 0 & 0 & 0 \\
            0 & 1 & 0 & 0
        \end{tabular}
    \right]
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
    D=
    \left[
        \begin{tabular}{ c }
            0 \\
            0
        \end{tabular}
    \right]
    \end{equation}
\end{center}

By substituting the system parameters below:

\begin{itemize}
    \item \textbf{Cart Position Rise Time}: $t_r\leq1.5s$
    \item \textbf{Maximum Pendulum Angle Deflection}: $|\alpha|\leq1.0$ deg
    \item \textbf{Maximum Control Effort (V)}: $|V_m|<10$ V
\end{itemize}

we can calculate the eigenvalues of matrix $A$, which yields open-loop poles located at
\\

\begin{center}
    $OL$ = $-16.26$, $-4.56$, $4.84$, and $0$
\end{center}


%----------------------------------------------------------------------------------------

\subsection*{(b) Linear Quadratic Regular (LQR)}

If (A,B) are controllable, then the LQR optimization method can be used to find a feedback control gain. Given the plant model we can find a control input $u$ that minimizes the cost function

\begin{center}
    \begin{equation}
        J=\int_{0}^{\infty} x(t)^TQx(t) + u(t)^TRu(t)dt
    \end{equation} \label{eq:costfunction}
\end{center}

where $Q$ and $R$ are the weighting matrices. The weighting matrices affect how LQR minimizes the function and are treated as tuning variables. Given the control law $u=-Kx$, the state-space becomes

\begin{center}
    \begin{equation}
        \dot{x} = Ax+B(-Kx) = (A-BK)x
    \end{equation}
\end{center}

%----------------------------------------------------------------------------------------

\subsection*{(c) Feedback Control}

The reference state of the feedback control loop that balances the linear pendulum is defined as
\\
\begin{center}
    $x_d=[c_{cd}$ $0$ $0$ $0]$
\end{center}

where $x_cd$ is the desired cart position. The controller is

\begin{center}
    \begin{equation}
        u=K(x_d-x)
    \end{equation}
\end{center}

Note that when $x_d=0$, then $u=-Kx$, which is the control used in the LQR algorithm.

\begin{figure}[H]
    \centering
    \includegraphics{lab3/IMG_StateFeedbackControlLoop.jpg}
    \caption{State-Feedback Control Loop}
    \label{fig:my_label}
\end{figure}

When running this on the physical system, the pendulum begin hanging in the downward position. We only want the balance control to be enabled when the pendulum is brought up around its upright vertical position. The controller is therefore

\begin{center}
    \begin{equation}
        u=
        \bigg\{
            \begin{tabular}{ c c }
                $K=(x_d-x)$ & $|x_2|<\epsilon$ \\
                0 & otherwise
            \end{tabular}
    \end{equation}
\end{center}

where $\epsilon$ is the angle about which the controller should engage. For example if $\epsilon = 10^\circ$, then the control will begin when the pendulum is within $\pm 10^\circ$ of its upright position, i.e., when $|x_2| < 10^\circ$.

%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------

\section*{Procedure}

For the performed experiments in the instructions below, we will need to use Matlab 2019b (other versions will not connect to the QUARC interface!). 

\subsection*{(a) Simulation}

Change the workspace directory to the folder on the Desktop labeled "ME141 Lab \#3" $>$ "Linear Inverted Pendulum". We will be exploring the state-space model of the linear inverted pendulum.

\begin{figure}[H]
    \centering
    \includegraphics{lab3/IMG_SimulinkSimulateDiagram.jpg}
    \caption{$s_sip_lqr$ Simulink diagram used to simulate the state-feedback control}
    \label{fig:my_label}
\end{figure}

\begin{itemize}
    \item[1.] Open the $setup\_ip02\_sip.m$ script and locate the sections shown below and ensure they show exactly as follows before continuing: \\
    \% if IP02: Type of Cart Load: set to 'NO\_LOAD', 'WEIGHT' \\
    IP02\_LOAD\_TYPE = 'NO\_LOAD'; \\
    \%IP02\_LOAD\_TYPE = 'WEIGHT'; \\
    \hspace{2mm} \\
    \textit{The above assigns zero weight to the system's pendulum tip} \\
    \hspace{2mm} \\
    \% \#\#\#\#\#\#\#\#\#\#\#\#\#\#\# USER-DEFINED CONTROLLER DESIGN \#\#\#\#\#\#\#\#\#\#\#\#\#\#\# \\
    \% Type of Controller: set it to 'LQR\_AUTO', 'MANUAL' \\
    \%CONTROLLER\_TYPE = 'LQR\_AUTO'; \% LQR controller design: automatic mode \\
    CONTROLLER\_TYPE = 'MANUAL'; \% controller design: manual mode \\
    \hspace{2mm} \\
    \textit{The above allows you to change the matrices in the parameters} \\
    \hspace{2mm} \\
    \% \#\#\#\#\#\#\#\#\#\#\#\#\#\#\# LQR CONTROL \#\#\#\#\#\#\#\#\#\#\#\#\#\#\# \\
    if strcmp ( CONTROLLER\_TYPE, 'MANUAL' ) \\
        $Q = diag([1 1 1 1]);$ \\
        $R = 0.1;$ \\
        $[ K, S, EIG\_CL ] = lqr( A, B, Q, R )$; \\
        \hspace{2mm} \\
    The $Q$ and $R$ are initially set to the default values of:
    \begin{equation}
        Q=
        \left[
            \begin{tabular}{ c c c c }
                1 & 0 & 0 & 0 \\
                0 & 1 & 0 & 0 \\
                0 & 0 & 1 & 0 \\
                0 & 0 & 0 & 1 \\
            \end{tabular}
        \right]
    \end{equation}
    \begin{center}
        and
    \end{center}
    \begin{center}
        R = 0.1
    \end{center}
    \item[2.] Run the script to generate the default gain $K$. \textit{Note: this will not give the desired response, but we will use it as a baseline gain $K$ to compare with as we change matrices $Q$ and $R$. }
    \item[3.] Run $s\_ip02\_sip.m$ to simulate the closed-loop response with this gain.
    \begin{itemize}
        \item If the scopes do not display any curves, begin the simulation from the green play button in any of the scope windows.
    \end{itemize}
    \item[4.] Alter the $R$ parameter to observe its effect on the response of the system. Observe also how the values of gain $K$ change.
    \item[5.] For $Q=diag[q_1,q_2,q_3,q_4]$, vary each $q_i$ independently and examine its effect on the gain and the closed-loop response. Vary each $q_i$ by the same order of magnitude and compare how the new gain $K$ changes compared to the original gain. \textit{Keep $R=0.1$ throughout your testing}. Record your results so you can document and explain them in your lab report.
    \item[6.] Find a $Q$ and $R$ that will satisfy the system specifications from \textit{Background (a)}.
    %Q=
    %\begin{tabular}{ c c c c }
    %            35 & 0 & 0 & 0 \\
    %            0 & 350 & 0 & 0 \\
    %            0 & 0 & 0.1 & 0 \\
    %            0 & 0 & 0 & 0.1 \\
    %        \end{tabular}
    %R=0.02
    %K=[-41.83 182.72 -46.56 25.96]
    \item[7.] Save the data from the workspace labeled:
    \begin{itemize}
        \item \textit{$data\_xc$}
        \begin{itemize}
            \item time = \textit{$data\_xc$(:,1)}
            \item set-point position = \textit{$data\_xc$(:,2)}
            \item measured position = \textit{$data\_xc$(:,3)}
        \end{itemize}
    \end{itemize}
    \begin{itemize}
        \item \textit{$data\_alpha$}
        \begin{itemize}
            \item time = \textit{$data\_alpha$(:,1)}
            \item measured angle = \textit{$data\_alpha$(:,2)}
        \end{itemize}
    \item \textit{$data\_vm$}
        \begin{itemize}
            \item time = \textit{$data\_vm$(:,1)}
            \item input voltage = \textit{$data\_vm$(:,2)}
        \end{itemize}
    \end{itemize}
\end{itemize}

\subsection*{(b) Control Implementation}

Open Simulink file named $q\_sip\_lqr$ to view the block diagram as seen below: \\

\begin{figure}[H]
    \centering
    \includegraphics{lab3/IMG_SimulinkImplementDiagram.jpg}
    \caption{$q\_sip\_lqr$ Simulink diagram used to implement the state-feedback control}
    \label{fig:my_label}
\end{figure}

The \textit{Amplitude (m)} gain block is used to change the desired cart position. The state-feedback gain $K$ is read from the Matlab workspace. The \textit{SIP} + \textit{IP02: Actual Plant} block interfaces with the IP02 cart motor and sensors of the system. The \textit{SIP} + \textit{IP02: State-Space Model} and \textit{Find State X} blocks are used to simulate the response of the inverted pendulum using the linear state-space model.

\begin{itemize}
    \item[1.] Run the $setup\_ip02\_sip$ script with the gain $K$ you calculated in the previous steps
    \item[2.] Turn on the Amplifier and set it to 1x and ensure the pendulum is centered 
    \item[3.] Open the $q\_sip\_lqr$ Simulink file
    \item[4.] At the top, open the "$Monitor$ $\&$ $Tune$" drop-down menu and click on "$Build$ $for$ $Monitoring$"
    \item[5.] Connect to the system and click $Run$
    \begin{itemize}
        \item Once the system is running, the cart will not move until the pendulum is stood vertically
        \item Manually rotate the pendulum until you feel the voltage take control of the pendulum
        \item Do \textbf{NOT} manually apply force to the cart or the pendulum while the control is operational
    \end{itemize}
    \item[6.] Once the system has balanced the pendulum, introduce the $\pm$ 100 mm cart position command by setting the \textit{Amplitude (mm)} gain in the Simulink diagram to 100.
    \item[7.] Allow for a full cycle to display on the scope before stopping the controller
    \begin{itemize}
        \item \textbf{The pendulum will fall after being released by the controller; keep clear of the system}
    \end{itemize}
    \item[8.] Save the data from the workspace labeled:
    \begin{itemize}
        \item \textit{$data\_xc$}
        \begin{itemize}
            \item time = \textit{$data\_xc$(:,1)}
            \item set-point position = \textit{$data\_xc$(:,2)}
            \item measured position = \textit{$data\_xc$(:,3)}
        \end{itemize}
    \end{itemize}
    \begin{itemize}
        \item \textit{$data\_alpha$}
        \begin{itemize}
            \item time = \textit{$data\_alpha$(:,1)}
            \item measured angle = \textit{$data\_alpha$(:,2)}
        \end{itemize}
    \item \textit{$data\_vm$}
        \begin{itemize}
            \item time = \textit{$data\_vm$(:,1)}
            \item input voltage = \textit{$data\_vm$(:,2)}
        \end{itemize}
    \end{itemize}
    \item[9.] Verify the pendulum response characteristics and control action satisfy the control parameters
\end{itemize}

%----------------------------------------------------------------------------------------
%	SECTION 4
%----------------------------------------------------------------------------------------

\section*{Action Items}

\begin{itemize}
    \item[1.] Discuss whether the inverted pendulum system (without the control) is stable, marginally stable  or unstable. Reference the open-loop poles in your discussion.    
    \item[2.] Designing a controller with the LQR technique is an iterative process. In order to gain some insight into how changing the different elements in $Q$ and $R$ will affect the response, we only change the diagonal elements in $Q$, thus let:
    \begin{align}
        Q = \left[ \begin{matrix}
        q_{1} & 0 & 0 & 0 \\
        0 & q_{2} & 0 & 0 \\
        0 & 0 & q_{3} & 0 \\
        0 & 0 & 0 & q_{4}
        \end{matrix} \right ]
    \end{align}
    Since we are dealing with a single-input system, $R$ is a scalar value. Using the $Q$ and $R$ defined, expand the cost function (Equation 10).
    \item[3.] For the feedback control $u=-Kx$, the LQR algorithm finds a gain $K$ that minimizes the cost function $J$. Matrix $Q$ sets the weight on the states and determines how $u$ will minimize $J$ (and hence how it generates gain $K$). From \textit{Action Item 2}, explain how increasing each of the diagonal elements, $q_i$ affects the generated gain $K=[k_1 \; k_2 \; k_3 \; k_4]$.
    \item[4.] State and explain how increasing $R$ affects the generated gain $K$.
    \item[5.] Provide a graph showing the simulated and control implementation responses.
    \item[6.] Calculate the rise time and maximum pendulum angle of the simulated and control implementation responses.
    \item[7.] Briefly discuss any sources of error, and how they affect your final results.
\end{itemize}

\pagebreak

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

% \bibliographystyle{apalike}

% \bibliography{sample}

%----------------------------------------------------------------------------------------
%	Position Control Files
%----------------------------------------------------------------------------------------

\begin{table}[h!]
\begin{center}
\begin{tabular}{|c|c|}
\hline
$\boldsymbol{File Name}$  & $\boldsymbol{Description}$ \\
\hline
setup\_ip02\_sip.m & Run this file only to set up the initial part of the experiment's inverted \\
 & pendulum control parameter\\
\hline
config\_ip02.m & Returns the configuration-based IP02 model specifications \\
 & $Rm$, $Jm$, $Kt$, $Eff\_m$, $Km$, $Kg$, $Eff_{g}$, $M$, $r\_mp$,
and $Beq$ \\
\hline
config\_sp.m & Returns the configuration-based pendulum specifications\\
\hline
d\_ip02\_sip\_lqr.m & Determines the control gain $K$ using LQR. \\
\hline
SPG\_ABCD\_sqns\_student.m & Creates the state space model of the linear inverted pendulum system. \\ 
\hline
s\_sip\_lqr.mdl & Simulink file that simulates the closed-loop pendulum
gantry \\
 & state-feedback control step response \\
\hline
q\_sip\_lqr.mdl & Simulink to implement the closed-loop IP02 lead speed controller using QUARC \\
\hline
\end{tabular}
\caption{Matlab files needed for the Inverted Pendulum Control Experiment}
\end{center}
\end{table}

%----------------------------------------------------------------------------------------

\end{document}