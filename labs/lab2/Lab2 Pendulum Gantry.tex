
\makeatletter
\def\input@path{{../styles/}{../../styles/}{../../../styles/}{../}{../../}{../../../}}
\makeatother
\documentclass{ee122_labs}
\input{macros.tex}
\input{preamble.tex}


%----------------------------------------------------------------------------------------
%	DOCUMENT INFORMATION
%----------------------------------------------------------------------------------------

\begin{document}

\begin{center}
\Large{
\textbf{School of Engineering} \\
\textbf{University of California, Merced} \\
\noindent\rule{6.5in}{1.5pt} \\
\textbf{ME 141 - Control Engineering} \\
\textbf{ } \\
 \vspace{150mm}
\textbf{\large{Experiment No. Two}} \\
\textbf{ } \\
\textbf{Pendulum Gantry}
}
\end{center}

\pagebreak

% If you wish to include an abstract, uncomment the lines below
% \begin{abstract}
% Abstract text
% \end{abstract}

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------

\section*{Objectives}

\begin{itemize}
    \item[1.] Develop a mathematical model of a gantry pendulum using Lagrangian mechanics.
    \item[2.] Obtain a linear state-space representation of an open-loop system .
    \item[3.] Learn to apply fundamentals of state-space modeling and state-feedback.
    \item[4.] Learn about pole-placement.
\end{itemize} 
 
%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section*{Background}

\subsection*{(a) Modeling the System}

The linear Single Pendulum Gantry (spg) model is shown below: \\

\begin{figure}[H]
    \centering
    \includegraphics{lab2/IMG_LinearGantryPendulumSchematic.jpg}
    \caption{Desired closed-loop pole locations}
    \label{fig:4}
\end{figure}

The pendulum pivot is on the IP02 cart, and is measured using the $Pendulum$ encoder. The pendulum has mass, $M_p$, the centre of mass of the pendulum is at length, $l_p$, and the moment of inertia about the centre of mass is $J_p$. The pendulum angle, $\alpha$, is zero when it is suspended perfectly vertically and increases positively when rotated counter-clockwise (CCW). The positive direction of linear displacement of the cart, $x_c$, is to the right when facing the cart. The position of the pendulum centre of gravity is denoted as the ($x_p$; $y_p$) coordinate. The nonlinear equations of motion for the cart and for the pendulum, respectively, are:

\begin{center}
    \begin{equation}
        (J_{eq}+M_p)\Ddot{x}_c+M_pl_pcos(\alpha)\Ddot{\alpha}-M_pl_psin(\alpha)\dot{\alpha}^2=F_c-B_{eq}\dot{x}_c
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
        M_pl_pcos(\alpha)\Ddot{x}_c+(J_{p}+M_pl_p^2)\Ddot{\alpha}+M_pl_pgsin(\alpha)=-B_{p}\dot{\alpha}
    \end{equation}
\end{center}
where $F_c$ is the linear force applied to the cart,  $M_p$ is the mass of pendulum, $l_p$ is the length of center of mass of pendulum from pivot, $J_{eq}$ is the effective mass of the cart, $J_p$ is the moment of inertia of the pendulum about the center of mass, $g$ is the acceleration due to gravity, and $B_{eq}$ is the equivalent viscous damping coefficient. This is our control input to the system.
These equations match the standard form for a single body's equations of motion:

\begin{center}
    \begin{equation}
        J\Ddot{x}+b\dot{x}+g(x)=F
    \end{equation}
\end{center}

These equations of motion can be linearized to give the following linearized equations of motion:
\begin{align}
(J_{eq}+M_p)\Ddot{x}_c+M_pl_p\Ddot{\alpha} &= F_c-B_{eq}\dot{x}_c   \label{eq:EOM1} \\
M_p l_p \Ddot{x}_c+(J_{p}+M_pl_p^2)\Ddot{\alpha}+M_p l_p g \alpha &=-B_{p}\dot{\alpha}  \label{eq:EOM2}
\end{align}
Thus, we can linearize as a state-space model:

\begin{center}
    \begin{equation} \label{eq:statespaceform}
        \dot{x}=Ax+Bu
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
        y=Cx+Du
    \end{equation}
\end{center}

where $x$ is the state, $u$ is the control input, and $A$, $B$, $C$, and $D$ are the state-space matrices. The state $x$ is a 4x1 vector given by the cart position $x_c$, pendulum angle $\alpha$, cart speed $\dot{x}_c$, and pendulum angular velocity $\dot{\alpha}$ and can be written as the vector:
\begin{align}
    x = \left[ \begin{matrix}
        x_c \\
        \alpha \\
        \dot{x}_c \\
        \dot{\alpha}
    \end{matrix} \right] 
\end{align}
The output $y$ of the system is partial, and consists of the measurements of cart position and the pendulum angle:
\begin{align}
    y = \left[ \begin{matrix}
        x_c \\
        \alpha
    \end{matrix} \right] 
\end{align}
Therefore, the $A$ matrix is 4x4, $B$ is 4x1, $C$ is a 4x2, and $D$ is 2x1. Based on this partial output, the matrices $C$ and $D$ are:
\begin{align}
    C = \left[ \begin{matrix}
        1 & 0 & 0 & 0\\
        0 & 1 & 0 & 0
        \end{matrix} \right ]
\end{align}
and
\begin{align}
    D = \left[ \begin{matrix}
        0 \\
        0 
        \end{matrix} \right ]
\end{align}

In this lab, we will design and implement a controller of the form:
\begin{align}
 u = K (x_d - x)    
\end{align}
where $K$ is a vector of gains for each variable in the state vector, $x_d = [x_{cd} 0 0 0]^T$ is the desired state vector, and $x_{cd}$ is the desired cart position. We can pick the gains $K$ to give desired poles for the closed-loop system.

%----------------------------------------------------------------------------------------

\subsection*{(b) Gantry Control}

For controlling the gantry, we will set the requirement for the response of the tip of the suspended pendulum to satisfy the following conditions:

\begin{itemize}
    \item Percent Overshoot: $PO \leq 5 \%$
    \item Percent Undershoot: $PU \leq 10 \%$
    \item Settling Time ($2\%$): $t_s \leq 2.2 s$
    \item Steady-state Error: $e_{ss} = 0$
    \item Maximum Control Effort (V): $|V_m| < 10 V$.
\end{itemize}

The linear pendulum gantry system has four poles where $p_1$ and $p_2$ are the complex conjugate \textit{dominant} poles and are chosen to satisfy the setting time and overshoot specifications. Let the conjugate poles be:

\begin{center}
    \begin{equation}
        p_1=-\sigma+j \omega_d
    \end{equation}
\end{center}

and

\begin{center}
    \begin{equation}
        p_2=-\sigma-j \omega_d
    \end{equation}
\end{center}

where $\sigma=\zeta\omega_n$, and $\omega_d=\omega_n\sqrt{1-\zeta^2}$ is the \textit{damped} natural frequency. The natural frequency, $\omega_n$, and damping ratio, $\zeta$, required to meet the specifications can be found using:

\begin{center}
    \begin{equation}
        PO=\frac{100(y_{max}-R_0)}{R_0}
    \end{equation}
\end{center}

The remaining closed-loop poles, $p_3$ and $p_4$, are placed along the real-axis to the left of the dominant poles as seen in figure \ref{fig:complex_plane_poles}. Since the real part of these poles are more negative, their associated transients will decay faster, leading the system response to be dominated by the poles $p_1$ and $p_2$.

\begin{figure}[H]
    \centering
    \includegraphics{lab2/IMG_Close-Loop_pole_locations.jpg}
    \caption{Desired closed-loop pole locations}
    \label{fig:complex_plane_poles}
\end{figure}

The feedback control loop that controls the pendulum gantry is shown below. The reference state is defined as

\begin{center}
    \begin{equation}
        x_d=[x_{cd} \; 0 \; 0 \; 0]
    \end{equation}
\end{center}

where $x_cd$ is the desired cart position. The controller is $u=K(x_d-x)$

\begin{figure}[H]
    \centering
    \includegraphics{lab2/IMG_StateFeedbackControlLoop.jpg}
    \caption{Desired closed-loop pole locations}
    \label{fig:1}
\end{figure}

%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------

\section*{Procedure}

For the performed experiments in the instructions below, we will need to use Matlab 2019b (other versions will not connect to the QUARC interface!). 

\subsection*{(a) Model Analysis}

Change the workspace directory to the folder on the Desktop labeled "ME141 Lab \#2" $>$ "Gantry Pendulum". We will be exploring the state-space model of the linear gantry pendulum. 

\begin{itemize}
    \item[1.] Open and run the $setup\_ip02\_spg$ script
    \item[2.] Open the $SPG\_ABCD\_eqns\_student.m$ script and enter the state-space matrices that you calculate under "Action Items"
%Jt = Jp*Jeq+Jeq*Mp*lp^2 + Mp*Jp;
%A =
%   [0 0 1 0;
%   0 0 0 1;
%   0 Mp^2*lp^2*g/Jt -Beq*(Jp+Mp*lp^2)/Jt Mp*lp*Bp/Jt;
%   0 -Mp*g*lp*(Jeq+Mp)/Jt Beq*Mp*lp/Jt -Bp*(Jeq+Mp)/Jt];
%B = [0; 0; (Jp+Mp*lp^2)/Jt; -Mp*lp/Jt];
%C = eye(2,4);
%D = zeros(2,1);
    % \item[3.] Run the $SPG\_ABCD\_eqns\_student.m$ script 
    \item[3.] Run the $setup\_ip02\_spg$ script with the CONTROLLER\_TYPE set to `MANUAL'. This will call the function $SPG\_ABCD\_eqns\_student$ and output the state-space matrices that you entered. You can confirm that you entered these correctly by running the $setup\_ip02\_spg$ script with the CONTROLLER\_TYPE set to 'PP\_AUTO' and comparing the elements of the state-space matrices. 
%A =
%   0 0 1.0000 0
%   0 0 0 1.0000
%   0 1.5216 -11.6513 0.0049
%   0 -26.1093 26.8458 -0.0841
%B =
%   0
%   0
%   1.5304
%   -3.5261
    \item[4.] Identify the open-loop poles of the system
%eig(A) = -11.3975, -0.1689 + 4.8040i, -0.1689 - 4.8040i, and 0
\end{itemize}

\subsection*{(b) Simulation}

Open Simulink file named $s\_spg\_pp$ to view the block diagram as seen below: \\

\begin{figure}[H]
    \centering
    \includegraphics{lab2/s_spg_pp Simulink Block.jpg}
    \caption{Simulink diagram for Pendulum Gantry Controller Simulation}
    \label{fig:2}
\end{figure}

\begin{itemize}
    \item[1.] Run the $setup\_ip02\_spg$ script and enter the calculated gain $K$
    \item[2.] Run the $s\_spg\_pp.mdl$ Simulink file; save the data from the workspace labeled:
    \begin{itemize}
        \item $data\_pend\_pos$
        \begin{itemize}
            \item time = $data\_pend\_pos(:,1)$
            \item target pendulum tip position = $data\_pend\_pos(:,2)$
            \item measured pendulum tip position = $data\_pend\_pos(:,3)$
        \end{itemize}
    \end{itemize}
    \begin{itemize}
        \item $data\_vm$
        \begin{itemize}
            \item time = $data\_vm(:,1)$
            \item control input = $data\_vm(:,2)$
        \end{itemize}
    \end{itemize}
    \item[3.] Verify the pendulum response characteristics and control action satisfy the control parameters
\end{itemize}

\subsection*{(c) Full-State Feedback}

In full-state feedback, the "full state" is available to the control. This means that the all the state variables, i.e. the cart position and speed and the pendulum angle and angular acceleration, are measured and known. So the controller can calculate a control signal based on all information in the state. 

Open the Simulink file named $q\_spg\_pp$ to view the block diagram as seen below: \\

\begin{figure}[H]
    \centering
    \includegraphics{lab2/IMG_q_spg_pp.jpg}
    \caption{Simulink diagram for Pendulum Gantry Controller}
    \label{fig:3}
\end{figure}

\begin{itemize}
    \item[1.] Run the $setup\_ip02\_spg$ script then enter the calculated gain $K$
    \item[2.] Turn on the physical amplifier unit and ensure the switch is set to 1x
    \item[3.] Assign the following parameters to the $ Signal$ $Generator$:
    \begin{itemize}
        \item Signal Type = $square$
        \item Amplitude = $1$
        \item Frequency = $0.1 Hz$  
    \end{itemize}
    \item[4.] Open the $Amplitude$ $(m)$ gain block and set the value to $0.03$ to generate a step size of 30 millimeters
    \item[5.] At the top, open the "$Monitor$ $\&$ $Tune$" drop-down menu and click on "$Build$ $for$ $Monitoring$"
    \item[6.] Ensure the pendulum is hanging down and motionless
    \item[7.] Run the file and allow for the scopes to display a full cycle before stopping
    \begin{itemize}
        \item $Pend$ $Tip$ $Pos$ $(mm)$ scope traces
        \begin{itemize}
            \item Yellow = Set point
            \item Purple = Measured Position
            \item Cyan = Simulated Position
        \end{itemize}
    \end{itemize} 
    \item[8.] Export the data from $data\_pos$ and $data\_vm$
\end{itemize}

\subsection*{(d) Partial-State Feedback}

In partial-state feedback, only part of the state is known to the controller. In this case, the cart position and speed are known, but the pendulum angle and angular velocity are unknown. This changes the effectiveness of the controller.

You will be using the same $q\_spg\_pp$ Simulink file for part (c)

\begin{itemize}
    \item[1.] Change the \textit{Signal Generator} step reference block to have the following values:
    \begin{itemize}
        \item Signal type = $square$
        \item Amplitude = $1$
        \item Frequency = $0.1 Hz$
    \end{itemize}
    \item[2.] Set the $Amplitude$ $(m)$ gain block to $0.03$ to generate a step of $30$ $mm$
    \item[3.] Set the \textit{Manual Switch} to the \textit{Partial-State Feedback} (downward) position
    \item[4.] At the top, open the "$Monitor$ $\&$ $Tune$" drop-down menu and click on "$Build$ $for$ $Monitoring$"
    \begin{itemize}
        \item Verify that the amplifier is turned on with the gain set to 1x
        \item Ensure the pendulum is hanging down and motionless
    \end{itemize}
    \item[5.] Once the file has compiled, click on $Connect$ then $Start$; "$Stop$" when you see a full cycle on the scopes
\end{itemize}

%----------------------------------------------------------------------------------------
%	SECTION 4
%----------------------------------------------------------------------------------------

\section*{Action Items}

\begin{itemize}
    \item[1.] Fit the two linear equations of motion (equations \ref{eq:EOM1} and \ref{eq:EOM2}) into the matrix form in terms of the state variables $x_c$, $\dot{x}_c$, $\alpha$ and $\dot{\alpha}$ and the system constants. Your result should be in the form:
    \begin{align}
        \left[ \begin{matrix}
        d_{11} & d_{12} \\
        d_{21} & d_{22}
        \end{matrix} \right ] 
        \left[ \begin{matrix}
        \ddot{x}_c \\
        \ddot{\alpha}
        \end{matrix} \right ] 
        +
        \left[ \begin{matrix}
        c_{11} & c_{12} \\
        c_{21} & c_{22}
        \end{matrix} \right ] 
        \left[ \begin{matrix}
        \dot{x}_c \\
        \dot{\alpha}
        \end{matrix} \right ]
        +
        \left[ \begin{matrix}
        g_{11} & g_{12} \\
        g_{21} & g_{22}
        \end{matrix} \right ] 
        \left[ \begin{matrix}
        x_c \\
        \alpha
        \end{matrix} \right ]
        =       
        \left[ \begin{matrix}
        F_1 \\
        F_2
        \end{matrix} \right ]    \end{align}   
    
    \item[2.] Solve your result to get independent equations for the cart acceleration $\ddot{x}_c$ and the pendulum angular acceleration $\ddot{\alpha}$. Hint: You can achieve this by pre-multiplying by the inverse of matrix $d$, whose inverse is given by:
    \begin{align}
        d^{-1} = \left[ \begin{matrix}
        d_{11} & d_{12} \\
        d_{21} & d_{22}
        \end{matrix} \right ]^{-1} 
        = 
        \frac{1}{\text{det}(d)} \left[ \begin{matrix}
        d_{22} & -d_{12} \\
        -d_{21} & d_{11}
        \end{matrix} \right ]
    \end{align}
    You will end up with two equations of the form: $\ddot{x}_c = f_1(x_c, \alpha, \dot{x}_c, \dot{\alpha})$ and $\ddot{\alpha} = f_2(x_c, \alpha, \dot{x}_c, \dot{\alpha})$. The equations will also contain the system constants from the equations of motion such as $M_p$, $l_p$, etc.
    Find the matrices $A$ and $B$ that allow you to write the system in linear state-space form as given in equation \ref{eq:statespaceform}.
    \item[3.] Find the open-loop poles of the system using Matlab. The open-loop poles are the eigenvalues of the state matrix, $A$. The MATLAB function $eig$ can help.
    \item[4.] Derive the characteristic equation of $A$ using the open-loop poles.
    \item[5.] Identify the location of the two dominant poles, $p_1$ and $p_2$ to satisfy the time-domain specifications for percent overshoot and settling time. We will place the other poles at $p_3=-20$ and $p_4=-40$. Note that here, the 2\% settling time is used, which is related to the damping coefficient and natural frequency by the equation:
    \begin{align*}
        t_s = -\frac{\ln{0.02}}{\zeta \omega_n} \approx \frac{4}{\zeta \omega_n}
    \end{align*}
    Use the MATLAB $place$ command (or $acker$), to calculate the gains $K$ that will place the closed-loop poles at the desired locations. These should be:
    \begin{align*}
        K = 
        \left[ \begin{matrix}
        160.5347  & -210.625 & 88.0092 & 23.4776
        \end{matrix} \right ]
    \end{align*}
    You can confirm that you entered these correctly by running the $setup\_ip02\_spg$ script with the CONTROLLER\_TYPE set to 'PP\_AUTO' and comparing the elements of the state-space matrices. Write down the matrices $A$ and $B$ that you obtain from running $setup\_ip02\_spg$ with the CONTROLLER\_TYPE set to 'MANUAL' which uses the state-space matrices you derived. 
    
    \item[6.] Provide a graph showing the measured pendulum tip response using state-feedback.
    \item[7.] Calculate the steady-state error, the percent overshoot, and the peak time for the pendulum tip.
    \item[8.] Discuss the difference between the \textit{Full-State Feedback} and the \textit{Partial-State Feedback} responses.
    \item[9.] Briefly discuss any sources of error, and how they affect your final results.
\end{itemize}

\pagebreak

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

% \bibliographystyle{apalike}

% \bibliography{sample}

%----------------------------------------------------------------------------------------
%	Position Control Files
%----------------------------------------------------------------------------------------

\begin{table}[h!]
\begin{center}
\begin{tabular}{|c|c|}
\hline
$\boldsymbol{File Name}$  & $\boldsymbol{Description}$ \\
\hline
setup\_ip02\_spg.m & Run this file only to set up the experiment's gantry control parameters. \\
 & \\
\hline
config\_ip02.m & Returns the configuration-based IP02 model specifications \\
 & $Rm$, $Jm$, $Kt$, $Eff\_m$, $Km$, $Kg$, $Eff_{g}$, $M$, $r\_mp$,
and $Beq$ \\
\hline
config\_sp.m & Returns the configuration-based pendulum specifications\\
\hline
d\_ip02\_spg\_pp.m & Determines the control gain $K$. \\
 & \\
\hline
SPG\_ABCD\_sqns\_student.m & Creates the state space model of the linear pendulum gantry system. \\
& MATLAB variables are defined as:  \\
 & Mp = mass of pendulum, $M_p$ \\
 & lp = length of center of mass of pendulum from pivot, $l_p$  \\
 & Jeq = effective mass of the cart, $J_{eq}$ \\
 & Jp = moment of inertia of the pendulum about the center of mass, $J_p$  \\
 & g = acceleration due to gravity, $g$ \\
 & Beq = equivalent viscous damping coefficient, $B_{eq}$  \\ 
\hline
s\_spg\_pp.mdl & Simulink file that simulates the closed-loop pendulum
gantry state-feedback control step response. \\
\hline
q\_spg\_pp.mdl & Simulink to implement the closed-loop IP02 lead speed controller using QUARC \\
\hline
q\_spg\_mdl.mdl & Simulink file that simulates and compares the state-space
model to the linear pendulum gantry. \\
\hline
q\_spg\_pp\_l.mdl & Simulink file to implement the integrator in the closed-loop pendulum tip position controller \\
\hline
\end{tabular}
\caption{Matlab files needed for the Gantry Control Experiment}
\end{center}
\end{table}

%----------------------------------------------------------------------------------------

\end{document}