\makeatletter
\def\input@path{{../styles/}{../../styles/}{../../../styles/}{../}{../../}{../../../}}
\makeatother
\documentclass{ee122_labs}
\input{macros.tex}
\input{preamble.tex}

\begin{document}

\begin{center}
\Large{
\textbf{School of Engineering} \\
\textbf{University of California, Merced} \\
\noindent\rule{6.5in}{1.5pt} \\
\textbf{ME 141 - Control Engineering} \\
\textbf{ } \\
 \vspace{150mm}
\textbf{\large{Experiment No. Three}} \\
\textbf{ } \\
\textbf{Rotary Flexible Joint - Control Design}
}
\end{center}

\pagebreak

% If you wish to include an abstract, uncomment the lines below
% \begin{abstract}
% Abstract text
% \end{abstract}

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------

\section*{Objectives}

\begin{itemize}
    \item[1.] Design a state-feedback controller using Pole-Placement (PP).
    \item[2.] Simulate a closed-loop flexible joint system.
    \item[3.] Implement controller to assess behavior.
\end{itemize} 
 
%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section*{Background}
In this lab, we will design a controller for the Rotary Flexible Joint System. It consists of a rotating arm (or link) with a second arm connected to the end of the first arm with a flexible joint, as seen in figure \ref{fig:rotary_flexible_joint}. The second arm can be attached at different points to the first arm to give a different total length. However, once attached, the arms are fixed to one another and act as a single rigid-body arm. The base of the module is mounted on the load gear of the SRV02 system with a flexible, spring-loaded mount. The servo angle, $\theta$, increases positively when it rotates counter-clockwise (CCW). The servo (and thus the link) turn in the CCW direction when the control voltage is positive, i.e., $V_m > 0$. Since the link is mounted to the servo with springs, this means that the servo angle and the link angle can differ.

The total length of the link can be varied by changing the mounting position of the shorter top arm. The main bottom
arm, which is connected to the pivot, has a length of $L_1$ and a mass of $m_1$. The length and mass of the top link is
$L_2$ and $m_2$. The distance between the pivot and the middle of the top arm, which can be changed, is denoted by the
variable $d_{12}$. The moment of inertia of the entire link is specified by $J_l$ and it changes depending on the position of
the top arm. The deflection angle of the link itself is denoted as $\alpha$ and increases positively when rotated CCW. The control input is the servo motor voltage, $V_m$, which generates a torque $\tau$ at the base of the link.

\begin{figure} [H]
    \centering
    \includegraphics{lab5/rotary_flexible_joint.jpg}
    \caption{Rotary Flexible Joint Angles}
    \label{fig:rotary_flexible_joint}
\end{figure}

The state-space representation of the system is given by:
\begin{align}
    \dot{x} &= Ax + Bu \\
    y &= Cx + Du
\end{align}

The state $x$ consists of the servo angle, $\theta$, the link angle $\alpha$, the servo angular velocity, $\dot{\theta}$ and the link angular velocity, $\dot{\alpha}$:
\begin{align}
    x = [x_1 \quad x_2 \quad x_3 \quad x_4]^T = [\theta \quad \alpha \quad \dot{\theta} \quad \dot{\alpha}]^T
\end{align}

The measured output $y$ will be both the servo angle and the link angle:
\begin{align}
    y = [x_1 \quad x_2]^T = [\theta \quad \alpha]^T
\end{align}

This means that the output matrix, $C$, is:
\begin{align*}
    C = \left[ \begin{matrix}
1 & 0 & 0 & 0\\
0 & 1 & 0 & 0
\end{matrix} \right] 
\end{align*}
and the matrix $D$ is:
\begin{align*}
    D = \left[ \begin{matrix}
0\\
0
\end{matrix} \right] 
\end{align*}

The equations of motion for the angular velocities of the servo and the link are given by:
\begin{align}
    \dot{x}_3&=-\frac{B_{e q}}{J_{e q}} x_3+\frac{K_s}{J_{e q}} x_2+\frac{1}{J_{e q}} u \\
    \dot{x}_4&=\frac{B_{e q}}{J_{e q}} x_3-K_s\left(\frac{J_l+J_{e q}}{J_l J_{e q}}\right) x_2-\frac{1}{J_{e q}} u
\end{align}

This gives the following $A$ and $B$ matrices for the state-space representation:
\begin{align}
    A=\left[\begin{array}{cccc}
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \\
0 & \frac{K_s}{J_{e q}} & -\frac{B_{e q}}{J_{e q}} & 0 \\
0 & -\frac{K_s\left(J_l+J_{e q}\right)}{J_l J_{e q}} & \frac{B_{e q}}{J_{e q}} & 0
\end{array}\right]
\end{align}
and
\begin{align}
    B=\left[\begin{array}{c}
0 \\
0 \\
\frac{1}{J_{e q}} \\
-\frac{1}{J_{e q}}
\end{array}\right]
\end{align}
where $B_{eq}$ is the equivalent viscous damping, $J_{eq}$ is the equivalent moment of inertia, and $J_l$ is the total moment of inertia of the arm with both links. 
The values for the various parameters are provided in the Appendix, and the resulting numerical $A$ and $B$ matrices can be calculated using the MATLAB file $setup\_rotflex.m$ provided:

\begin{align}
    A &= \left[\begin{array}{cccc}
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \\
0 & 623.7 & -40.32 & 0 \\
0 & -1020.3 & 40.32 & 0
\end{array}\right] \\
B &= \left[\begin{array}{c}
0 \\
0 \\
61.63 \\
-61.63
\end{array}\right]
\end{align}

The four open loop poles of $A$, which can be found using MATLAB's eig(A), are:
\begin{align}
    p = \{-25.1,-7.63 \pm 24.1i,0\}
\end{align}
Note that this state-space form is valid but is not in controllable canonical form, which is the form which will be used throughout this lab. 
\section*{Control Design}
Consider the following specifications for this lab: \\

\textit{\textbf{Time-Domain requirements}}:

\begin{itemize}
    \item Servo angle 4\% settling time: $t_s \leq 0.5$ s
    \item Servo angle percentage overshoot: $PO \leq 5$ \%
    \item Maximum link angle deflection: $|\alpha| \leq 12.5^o$
    \item Maximum control effort voltage: $|v_m| \leq 10$ V
\end{itemize}

\textit{\textbf{Desired closed-loop poles}}:

\begin{itemize}
    \item Damping Ratio: $\zeta = 0.6$
    \item Natural Frequency: $\omega_n = 20$ rad/s
    \item Non-Dominant Poles: {$p_3 = -30, p_4 = -40$}
\end{itemize}

\subsection*{Stability \& Controllability}

A system's stability can be determined by its poles

\begin{itemize}
    \item Stable systems have poles only in the left-hand plane
    \item Unstable systems have at least one pole in the right-hand plane and/or poles of multiplicity greater than 1 on the imaginary axis
    \item Marginally stable systems have one pole on the imaginary axis and the other poles in the left-hand plane
\end{itemize}

The poles are the roots of the system's characteristic equation. From the state-space, the characteristic equation of the system can be found using

\begin{equation}
    det(sI-A)=0
\end{equation}

where $det(A)$ is the determinant function, $s$ is the Laplace operator, and $I$ the identity matrix. These are the eigenvalues of the state-space matrix $A$. If the control input, $u$, of a system can take each state variable, $x_i$ where $i$ = 1...$n$, from an initial state to a final state then the system is controllable, otherwise, it is uncontrollable. The system is controllable if the rank of its controllability matrix, $T$, also seen as $\mathcal{C}$ in class.

\begin{equation}
    T=[B\hspace{2mm}AB\hspace{2mm}A^2B\hspace{2mm}...\hspace{2mm}A^{n-1} B]
\end{equation}

\subsection*{Pole Placement \& Desired Poles}

If (A,B) are controllable, then the transformation to the controllable canonical form ($\Tilde{A},  \Tilde{B}$) will be controllable as well. We can then use pole placement to design the controller in the controllable canonical form and then transform back to the general form. Given the control law $u=-\Tilde{K}x$, the state-space equation becomes

\begin{center}
    \begin{equation}
        \dot{x}=\Tilde{A}x+\Tilde{B}(-Kx)=(\Tilde{A}-\Tilde{B}\Tilde{K})x
    \end{equation}
\end{center}

An example is shown below:

\begin{equation}
    \title{A}=
    \left[
        \begin{tabular}{ c c c }
                0 & 1 & 0 \\
                0 & 0 & 1 \\
                3 & -1 & -5 \\
        \end{tabular}
     \right]
\end{equation}
\begin{center}
    and
\end{center}
\begin{equation}
    \title{B}=
    \left[
        \begin{tabular}{ c }
                0 \\
                0 \\
                1 \\
        \end{tabular}
     \right]
\end{equation}

Note that $\Tilde{A}$ and $\Tilde{B}$ are already in controllable canonical form (or companion form). We want the closed-loop poles to be at [-1 -2 -3]. The desired characteristic equation is therefore

\begin{center}
    \begin{equation}
        (s+1)(s+2)(s+3)=s^3+6s^2+11s+6
    \end{equation}
\end{center}

For the gain $\tilde{K}=[\Tilde{k}_1 \hspace{2mm} \Tilde{k}_2 \hspace{2mm} \Tilde{k}_3]$, apply control $u=-\Tilde{K}x$ and get

\begin{equation}
    \Tilde{A}-\Tilde{B}\Tilde{K}=
    \left[
        \begin{tabular}{ c c c }
                0 & 1 & 0 \\
                0 & 0 & 1 \\
                3-$k_1$ & -1-$k_2$ & -5-$k_3$ \\
        \end{tabular}
     \right]
\end{equation}

The characteristic equation of $\Tilde{A}-\Tilde{B}\Tilde{K}$ is

\begin{equation}
    s^3+(k_3+5)s^2+(k_2+1)s+(k_1-3)
\end{equation}

Equating the coefficients and desired polynomial gives us

\begin{equation}
    \begin{tabular}{ c c c }
        $\tilde{k}_1$-3 & = & 6 \\
        $\tilde{k}_2$+1 & = & 11 \\
        $\tilde{k}_3$+5 & = & 6 \\
        \end{tabular}
\end{equation}

Solving for the gains, we can find that a gain of $\tilde{K}$ = [9 10 1] is required to move the poles to their desired location. We can generalize the procedure to design a gain $K$ for a controllable (A,B) system as follows:

\begin{itemize}
    \item[1. ] Find the matrices $A$ and $B$ in controllable. Compute $W=T\Tilde{T}^{-1}$.
    \item[2. ] Compute $\Tilde{K}$ to assign the poles of $\Tilde{A}-\Tilde{B}\Tilde{K}$ to the desired locations. Applying the control law $u=-\tilde{K}x$ to the system
    \begin{equation}
    \Tilde{A}=
    \left[
        \begin{tabular}{ c c c c c }
                0 & 1 & $\cdots$ & 0 & 0 \\
                0 & 0 & $\cdots$ & 0 & 0 \\
                $\vdots$ & $\vdots$ & $\ddots$ & $\vdots$ & $\vdots$ \\
                0 & 0 & $\cdots$ & 0 & 1 \\
                $-a_1-k_1$ & $-a_2-k_2$ & $\cdots$ & $-a_{n-1}-k_{n-1}$ & $-a_n-k_n$ \\
        \end{tabular}
     \right]
    \end{equation}
    \item[3. ] Find $K=\Tilde{K}W^{-1}$ to get the feedback gain for the original system (A,B).
\end{itemize}

It is important to do the $\Tilde{K}$ $\longrightarrow$ $K$ conversion. Remember that (A,B) represents the actual system while the companion matrices $\Tilde{A}$ and $\Tilde{B}$ do not. \\

The rotary inverted pendulum system has four poles. The image below depicts poles $p_1$ and $p_2$ are the complex conjugate dominant poles and are chosen to satisfy the natural frequency, $\omega_n$, and damping ratio, $\zeta$, specifications mentioned at the beginning of the handout. Let conjugate poles be

\begin{center}
    \begin{equation}
        p_1=-\sigma+j\omega_d
    \end{equation}
\end{center}
and

\begin{center}
    \begin{equation}
        p_2=-\sigma-j\omega_d
    \end{equation}
\end{center}

where $\sigma=\zeta \omega_n$ and $\omega_d=\omega_n\sqrt{1-\zeta^2}$ is the damped natural frequency. The remaining closed-loop poles, $p_3$ and $p_4$, are placed along the real-axis to the left of the dominant poles shown below.

\begin{figure} [H]
    \centering
    \includegraphics{lab5/IMG_DesiredClosedLoopPoleLocations.jpg}
    \caption{Desired Closed-Loop Pole Locations}
    \label{fig:1}
\end{figure}

\subsection*{Feedback Control}

The feedback control loop in the image below is designed to stabilize the servo to a desired position, $\theta_d$, while minimizing the deflection of the flexible link.

\begin{figure} [H]
    \centering
    \includegraphics{lab5/IMG_StateFeedbackControlLoop.jpg}
    \caption{State-Feedback Control Loop}
    \label{fig:2}
\end{figure}

The reference state is defined

\begin{center}
    \begin{equation}
        x_d=[\theta_d \hspace{2mm} 0 \hspace{2mm} 0 \hspace{2mm} 0]
    \end{equation}
\end{center}

and the controller is

\begin{center}
    \begin{equation}
        u=K(x_d-x)
    \end{equation}
\end{center}

Note that if $x_d=0$ then $u=-Kx$, which is used in the control algorithm.

%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------

\section*{Procedure}

Change the workspace directory to the folder on the Desktop labeled "ME141 Lab \#5" $>$ "Rotary Flexible Joint - Control Design".

\subsection*{Control Design}

\begin{itemize}
    \item[1. ] Open and run the file named $setup\_rotflex.m$ to load the model.
    \item[2. ] Use Matlab to determine if the system is controllable. (e.g. $ctrb$ \& $rank$)
    \item[3. ] Open the $d\_pole\_placement\_student.m$ script to modify to calculate the controllability matrix $T$.
    \item[4. ] Enter the companion gain, $\Tilde{K}$, as $K_c$ in $d\_pole\_placement\_student.m$ and modify it to find the gain $K$. Run the script again to calculate the feedback gain $K$ and record its values.
    \item[5. ] Evaluate the closed-loop poles of the system (eigenvalues of $A-BK$). Record the closed-loop poles of the system when using the gain $K$ calculated above. If the poles did not get placed in the desired locations, modify the control design until you achieve the positions required.
    \item[6. ] Check: Use MATLAB's in-built function "acker" or "place" to determine the matrix $K$ and confirm that it matches the results above.
\end{itemize}

\subsection*{Control Simulation}

\begin{figure} [H]
    \centering
    \includegraphics{lab5/IMG_SimulinkSimulation.jpg}
    \caption{Simulink Diagram for Simulating the State-Feedback Control}
    \label{fig:3}
\end{figure}

\begin{itemize}
    \item[1. ] Run $setup\_rotflex.m$ and update the gain $K$ found in the Control Design.
    \item[2. ] Open $s\_rotflex.mdl$ and verify the \textit{Manual Switch} is set to \textit{Full-State Feedback} (upward) position
    \item[3. ] Click Run to simulate the closed-loop response with this gain.
    \item[4. ] Save the data stored in $data\_theta$, $data\_alpha$, and $data\_Vm$
    \begin{itemize}
        \item $data\_theta$
        \begin{itemize}
            \item $data\_theta(:,1)$ = time
            \item $data\_theta(:,2)$ = desired rotary arm angle
            \item $data\_theta(:,3)$ = measured rotary arm angle
        \end{itemize}
        \item $data\_alpha$
        \begin{itemize}
            \item $data\_alpha(:,1)$ = time
            \item $data\_alpha(:,2)$ = pendulum angle
        \end{itemize}
        \item $data\_vm$
        \begin{itemize}
            \item $data\_vm(:,1)$ = time
            \item $data\_vm(:,2)$ = desired rotary arm angle
        \end{itemize}
    \end{itemize}
\end{itemize}

\subsection*{Control Implementation}

\begin{figure} [H]
    \centering
    \includegraphics{lab5/IMG_SimulinkImplement.jpg}
    \caption{Simulink Diagram for the Rotary Flexible Joint System}
    \label{fig:4}
\end{figure}

\begin{itemize}
    \item[1. ] Run $setup\_rotflex.m$ and update the gain $K$ found in the Control Design.
    \item[2. ] Open $q\_rotflex.mdl$ and verify the \textit{Manual Switch} is set to \textit{Full-State Feedback} (upward) position
    \item[3. ] Click on \textit{Build for Monitoring}, $Connect$, then $Start$
    \item[4. ] Save the data stored in $data\_theta$, $data\_alpha$, and $data\_Vm$
\end{itemize}

%----------------------------------------------------------------------------------------
%	SECTION 4
%----------------------------------------------------------------------------------------

\section*{Action Items}

\begin{itemize}
    \item[1. ] Using the open-loop poles, find the characteristic equation of the system.
    \item[2. ] Give the corresponding matrices $A$ and $B$ in controllable canonical form. You can compute the transformation matrix $W$ using the software.
    \item[3. ] Find the location of the two dominant poles, $p_1$ and $p_2$, based on the specifications mentioned at the beginning of the handout. Place the other poles at $p_3=-30$ and $p_4=-40$. Finally, give the desired characteristic equation.
    \item[4. ] When applying the control $u=-\Tilde{K}x$ to the controllable canonical form, it changes $(\Tilde{A},\Tilde{B})$ to $(\Tilde{A}-\Tilde{B}\Tilde{K},\Tilde{B})$. Find the gain $\Tilde{K}$ that assigns the poles to their new desired location. Then find the mgain $K$ that assigns the poles for the original system ($A,B$).
    \item[5. ] Calculate the steady-state error, the percent overshoot, and the peak time for the simulation and experimental implementation of the control design.
    \item[6. ] Briefly discuss any sources of error, and how they affect your final results.
\end{itemize}

\pagebreak

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

% \bibliographystyle{apalike}

% \bibliography{sample}

%----------------------------------------------------------------------------------------
%	Position Control Files
%----------------------------------------------------------------------------------------

\begin{table}[h!]
\begin{center}
\begin{tabular}{|c|c|}
\hline
$\boldsymbol{File Name}$  & $\boldsymbol{Description}$ \\
\hline
q\_servo\_pos.slx & Simulink model that applies a voltage to the motor and reads the load gear \\
 & angle of the Rotary Servo Base Unit \\
\hline
setup\_servo\_pos\_control.m & Run this file only to set up the experiment's Rotary Servo Base \\
 & Unit's control parameters. \\
\hline
config\_servo.m & Returns the configuration-based Rotary Servo Based Unit model specifications \\
 & $R_m$, $k_t$, $k_m$, $\eta_g$, $B_{eq}$, $J_{eq}$, and $\eta_m$, the sensor calibration constants \\
 & K\_POT and K\_ENC, and the amplifier limits VMAX\_AMP and IMAX\_AMP \\
 \hline
d\_model\_param.m & Calculates the Rotary Servo Base Unit model parameters K and $\tau$ based on the \\
 & device specifications $R_m$, $k_t$, $k_m$, $\eta_g$, $B_{eq}$, $J_{eq}$, and $\eta_m$ \\
 \hline
calc\_conversion\_constants.m & Returns various conversion factors \\
\hline
s\_servo\_pos\_cntrl & Simulink file that simlutates a closed-loop PID position controller for the \\
 & Rotary Servo Base Unit system \\
\hline
q\_servo\_pos\_cntrl & Simulink file that implements a closed-loop PID position controller on the \\
 & Rotary Servo Base Unit system \\
\hline
\end{tabular}
\caption{Matlab files needed for the Rotary Servo Base Unit}
\end{center}
\end{table}

\section*{Appendix}

Percent Overshoot (max): $PO=\frac{100(y_{max}-R_0)}{R_0}$ \\
Peak Time (max): $t_p=t_{max}-t_0$ \\
Percent Overshoot: $PO=100e^{\bigl(-\frac{\pi \zeta}{\sqrt{1-\zeta^2}}\bigl)}$ \\
Error Transfer Function: $E(s)=R(s)-Y(s)=\frac{R(s)}{1+C(s)P(s)}$ \\
Error for Step Response: $e_{ss}=R_0\bigl( \lim_{s\to0}\frac{(\tau s+1)s}{\tau s^2+s+K} \bigl)$

Rotary Flexible Joint System parameters:
\begin{align*}
    \begin{aligned}
B_{e q} & =0.004 \mathrm{~N} \cdot \mathrm{m} /(\mathrm{rad} / \mathrm{s}) \\
J_{e q} & =2.08 \times 10^{-3} \mathrm{~kg} \cdot \mathrm{m}^2 \\
m_1 & =0.064 \mathrm{~kg} \\
L_1 & =0.298 \mathrm{~m} \\
m_2 & =0.030 \mathrm{~kg} \\
L_2 & =0.156 \mathrm{~m} \\
B_l & =0
\end{aligned}
\end{align*}
\end{document}